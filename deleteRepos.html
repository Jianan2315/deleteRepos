<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GitHub 仓库批量删除（本地可视化）</title>
    <style>
        :root {
            --bg: #0b0f14;
            --panel: #111827;
            --muted: #9aa4b2;
            --text: #e5e7eb;
            --primary: #60a5fa;
            --danger: #ef4444;
            --success: #22c55e;
            --warn: #f59e0b;
            --border: #243244;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
        .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,.35); }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; justify-content: space-between; }
        h1 { font-size: 20px; margin: 0; letter-spacing: .3px; }
        .muted { color: var(--muted); }
        .content { padding: 20px; }
        .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 720px) { .row { grid-template-columns: repeat(3, 1fr); } }
        label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
        input[type="text"], input[type="password"] { width: 100%; background: #0f172a; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none; }
        input[type="text"]:focus, input[type="password"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(96,165,250,.15); }
        .btn { border: 1px solid var(--border); background: #0f172a; color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; transition: transform .05s ease, background .2s ease, border-color .2s ease; }
        .btn:hover { background: #0b1324; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { border-color: #1e40af; background: #1f2a44; }
        .btn-danger { border-color: #7f1d1d; background: #271515; }
        .btn-success { border-color: #14532d; background: #13221a; }
        .btn[disabled] { opacity: .6; cursor: not-allowed; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: #0f172a; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--muted); }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .switch { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
        .table-wrap { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead { background: #0f172a; }
        th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { text-align: left; font-weight: 600; color: #c7d2fe; }
        tbody tr:hover { background: rgba(96,165,250,.06); }
        .name { display: flex; flex-direction: column; }
        .badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
        .badge { font-size: 11px; padding: 3px 6px; border-radius: 6px; border: 1px solid var(--border); color: var(--muted); background: #0b1324; }
        .status { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
        .log { white-space: pre-wrap; background: #0b1324; border: 1px solid var(--border); color: #cbd5e1; padding: 12px; border-radius: 12px; }
        .footer { color: var(--muted); font-size: 12px; margin-top: 8px; }
        .danger-text { color: var(--danger); font-weight: 600; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header">
            <h1>GitHub 仓库批量删除（仅在本地打开此 HTML 使用）</h1>
            <span class="chip">安全提示：不要部署到公共网站</span>
        </div>
        <div class="content">
            <div class="row">
                <div>
                    <label>GitHub 用户名</label>
                    <input id="user" type="text" placeholder="your-username" />
                </div>
                <div>
                    <label>Personal Access Token（仅 classic，需勾选 <code>delete_repo</code>）</label>
                    <input id="token" type="password" placeholder="ghp_..." autocomplete="off" />
                </div>
                <div style="display:flex; align-items:flex-end; gap:8px;">
                    <button id="load" class="btn btn-primary">加载仓库</button>
                    <button id="clearToken" class="btn" title="清除内存中的 token">清空密钥</button>
                </div>
            </div>

            <div style="margin-top:16px;" class="toolbar">
                <label class="switch"><input id="fForks" type="checkbox"> 仅显示 Fork</label>
                <label class="switch"><input id="fPrivate" type="checkbox"> 仅显示 Private</label>
                <label class="switch"><input id="fArchived" type="checkbox" checked> 隐藏 Archived</label>
                <label class="switch"><input id="fMatch" type="text" placeholder="名称包含… (可选)" style="width:220px;"> </label>
                <span class="chip" id="repoCount">未加载</span>
            </div>

            <div style="margin-top:12px;" class="toolbar">
                <label class="switch"><input id="dryRun" type="checkbox" checked> Dry‑run（仅预演，不执行删除）</label>
                <button id="selectAll" class="btn">全选/反选</button>
                <button id="deleteBtn" class="btn btn-danger" disabled>删除所选</button>
            </div>

            <div style="margin-top:12px" class="table-wrap">
                <table id="table">
                    <thead>
                    <tr>
                        <th style="width:46px"><input type="checkbox" id="checkAll"></th>
                        <th>仓库</th>
                        <th style="width:90px">Fork</th>
                        <th style="width:90px">Private</th>
                        <th style="width:100px">Archived</th>
                        <th style="width:140px">状态</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">
                    <tr><td colspan="6" class="muted">未加载</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top:12px">
                <div class="footer">提示：删除操作不可恢复。若使用 Dry‑run，会仅显示“将要删除”的条目，不会真的请求 API。</div>
            </div>

            <div style="margin-top:16px">
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        const $ = (id) => document.getElementById(id);
        const state = {
            repos: [],           // 原始列表（全部）
            filtered: [],        // 过滤后
            selected: new Set(), // full_name 集合
        };

        const headers = () => ({
            'Authorization': 'token ' + ($('token').value || ''),
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28',
        });

        const log = (msg) => {
            const box = $('log');
            const now = new Date().toLocaleTimeString();
            box.textContent += `[${now}] ${msg}\n`;
            box.scrollTop = box.scrollHeight;
        };

        const api = async (url, opts={}) => {
            const res = await fetch(url, { ...opts, headers: { ...headers(), ...(opts.headers||{}) } });
            return res;
        };

        // 递归分页拉取（owner 身份）
        async function fetchAllRepos(user) {
            const perPage = 100;
            let page = 1;
            let all = [];
            while (true) {
                const url = `https://api.github.com/user/repos?affiliation=owner&per_page=${perPage}&page=${page}`;
                log(`GET ${url}`);
                const res = await api(url);
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`拉取失败 HTTP ${res.status}: ${txt}`);
                }
                const chunk = await res.json();
                all = all.concat(chunk);
                if (chunk.length < perPage) break; // 没有下一页
                page++;
            }
            // 只保留关键字段
            return all.map(r => ({
                full_name: r.full_name,
                name: r.name,
                html_url: r.html_url,
                fork: !!r.fork,
                private: !!r.private,
                archived: !!r.archived,
            }));
        }

        function applyFilter() {
            const onlyForks = $('fForks').checked;
            const onlyPrivate = $('fPrivate').checked;
            const hideArchived = $('fArchived').checked;
            const match = ($('fMatch').value || '').trim().toLowerCase();

            state.filtered = state.repos.filter(r => {
                if (onlyForks && !r.fork) return false;
                if (onlyPrivate && !r.private) return false;
                if (hideArchived && r.archived) return false;
                if (match && !r.name.toLowerCase().includes(match)) return false;
                return true;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = $('tbody');
            tbody.innerHTML = '';
            $('repoCount').textContent = `共 ${state.repos.length} 个，当前显示 ${state.filtered.length}`;

            if (state.filtered.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" class="muted">没有匹配的仓库</td>`;
                tbody.appendChild(tr);
                updateButtons();
                return;
            }

            for (const r of state.filtered) {
                const tr = document.createElement('tr');
                const checked = state.selected.has(r.full_name) ? 'checked' : '';
                tr.innerHTML = `
        <td><input type="checkbox" data-full="${r.full_name}" ${checked}></td>
        <td>
          <div class="name">
            <a target="_blank" rel="noopener noreferrer" href="${r.html_url}">${r.full_name}</a>
            <div class="badges">
              ${r.fork ? '<span class="badge">fork</span>' : ''}
              ${r.private ? '<span class="badge">private</span>' : ''}
              ${r.archived ? '<span class="badge">archived</span>' : ''}
            </div>
          </div>
        </td>
        <td>${r.fork ? '✔️' : '—'}</td>
        <td>${r.private ? '✔️' : '—'}</td>
        <td>${r.archived ? '✔️' : '—'}</td>
        <td class="status" id="st:${r.full_name}">—</td>
      `;
                tbody.appendChild(tr);
            }

            // 事件委托：选中逻辑
            tbody.onclick = (e) => {
                const t = e.target;
                if (t && t.matches('input[type="checkbox"][data-full]')) {
                    const key = t.getAttribute('data-full');
                    if (t.checked) state.selected.add(key); else state.selected.delete(key);
                    updateButtons();
                }
            };

            updateButtons();
        }

        function updateButtons() {
            const any = state.selected.size > 0;
            $('deleteBtn').disabled = !any;
        }

        $('selectAll').onclick = () => {
            // 如果当前视图里尚未全选，则全选；否则清除这些项
            const inView = new Set(state.filtered.map(r => r.full_name));
            const allSelected = state.filtered.every(r => state.selected.has(r.full_name));
            if (allSelected) {
                for (const k of Array.from(state.selected)) if (inView.has(k)) state.selected.delete(k);
            } else {
                for (const r of state.filtered) state.selected.add(r.full_name);
            }
            renderTable();
        };

        $('checkAll').onclick = (e) => {
            // 表头小复选框：行为与“全选/反选”一致
            $('selectAll').click();
            // 同步其自身勾选状态（根据是否已经全选）
            const allSelected = state.filtered.every(r => state.selected.has(r.full_name));
            e.target.checked = allSelected;
        };

        $('fForks').onchange = $('fPrivate').onchange = $('fArchived').onchange = $('fMatch').oninput = applyFilter;

        $('clearToken').onclick = () => {
            $('token').value = '';
            log('已清空 token（仅从内存移除，未写入任何存储）');
        };

        $('load').onclick = async () => {
            try {
                $('deleteBtn').disabled = true;
                state.selected.clear();
                $('tbody').innerHTML = `<tr><td colspan="6" class="muted">加载中…</td></tr>`;

                const user = $('user').value.trim();
                if (!user) { alert('请输入 GitHub 用户名'); return; }
                if (!$('token').value) { alert('请输入 PAT（需 delete_repo 权限）'); return; }

                const all = await fetchAllRepos(user);
                state.repos = all;
                applyFilter();
                log(`已加载 ${all.length} 个仓库。`);
            } catch (err) {
                log('❌ ' + (err && err.message ? err.message : err));
                alert('加载失败：' + err);
            }
        };

        $('deleteBtn').onclick = async () => {
            if (state.selected.size === 0) return;

            const dryRun = $('dryRun').checked;
            const total = state.selected.size;
            if (!dryRun) {
                const confirmText = `将删除 ${total} 个仓库，此操作不可恢复。\n\n请输入 YES 继续：`;
                const ans = prompt(confirmText, '');
                if (ans !== 'YES') { log('已取消删除'); return; }
            }

            const items = Array.from(state.selected);
            let ok = 0, fail = 0;

            for (const full of items) {
                const cell = document.getElementById(`st:${full}`);
                if (dryRun) {
                    cell.textContent = 'will delete';
                    cell.style.color = '#f59e0b';
                    log(`DRY‑RUN  ${full}`);
                    continue;
                }

                const url = `https://api.github.com/repos/${full}`;
                log(`DELETE ${url}`);
                try {
                    const res = await api(url, { method: 'DELETE' });
                    if (res.status === 204) {
                        ok++;
                        cell.textContent = 'deleted';
                        cell.style.color = '#22c55e';
                    } else {
                        fail++;
                        const txt = await res.text();
                        cell.textContent = `fail ${res.status}`;
                        cell.style.color = '#ef4444';
                        log(`失败 ${full}: HTTP ${res.status} ${txt}`);
                    }
                } catch (e) {
                    fail++;
                    cell.textContent = 'error';
                    cell.style.color = '#ef4444';
                    log(`异常 ${full}: ${e.message || e}`);
                }
            }

            if (!dryRun) {
                log(`完成：成功 ${ok}，失败 ${fail}`);
                // 从 state 中移除已成功删除的
                state.repos = state.repos.filter(r => !state.selected.has(r.full_name));
                state.selected.clear();
                applyFilter();
            } else {
                log(`Dry‑run 完成：共标记 ${items.length} 个将删除`);
            }
        };
    })();
</script>
</body>
</html>
